<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gamepiece.admin.user.mapper.UserMapper">

	<resultMap type="User" id="userResultMap">
		<id column="id" property="id" />
		<result column="authrt_cd" property="authrtCd"/>
		<result column="authrt_nm" property="authrtNm"/>
		<result column="user_pw" property="userPswd"/>
		<result column="user_nm" property="userNm"/>
		<result column="user_gender" property="userGender"/>
		<result column="user_eml_addr" property="userEmlAddr"/>
		<result column="user_brdt" property="userBrdt"/>
		<result column="user_telno" property="userTelno"/>
		<result column="user_nn" property="userNn"/>
		<result column="join_ymd" property="joinYmd"/>
		<result column="whdwl_ymd" property="whdwlYmd"/>
		<result column="login_no" property="loginNo"/>
		<result column="lgn_dt" property="lgnDt"/>
		<result column="inactive_days" property="inactiveDays"/>
	</resultMap>

	<!-- 전체 회원정보 조회 -->
	<select id="getAllUserInfo" parameterType="string" resultMap="userResultMap">
		SELECT
			*
		FROM
			user
		WHERE
			whdwl_ymd IS NULL;
	</select>
	
	<!-- 회원 상세정보 조회 -->
	<select id="getUserInfo" parameterType="string" resultMap="userResultMap">
		SELECT
			*
		FROM
			user u INNER JOIN authrt ar
			ON u.authrt_cd = ar.authrt_cd
		WHERE
			id = #{id};
	</select>
	
	<!-- 회원 상세정보 수정 -->
	<update id="modifyUserInfo" parameterType="User">
		UPDATE user
		<set>
		<!-- <trim prefix="SET" suffixOverrides=","> -->
			<if test="authrtCd != null and authrtCd != ''">
				authrt_cd = #{authrtCd},
			</if>
			<if test="userPswd != null and userPswd != ''">
				user_pw = #{userPswd},
			</if>
			<if test="userNm != null and userNm != ''">
				user_nm = #{userNm},
			</if>
			<if test="userGender != null and userGender != ''">
				user_gender = #{userGender},
			</if>
			<if test="userEmlAddr != null and userEmlAddr != ''">
				user_eml_addr = #{userEmlAddr},
			</if>
			<if test="userBrdt != null and userBrdt > 0">
				user_brdt = #{userBrdt},
			</if>
			<if test="userTelno != null and userTelno != ''">
				user_telno = #{userTelno},
			</if>
			<if test="userNn != null and userNn != ''">
				user_nn = #{userNn}
			</if>
		<!-- </trim> -->
		</set>
		WHERE
			id = #{id};
	</update>
	
	<!-- 탈퇴 회원정보 조회 -->
	<select id="getRemoveUserInfo" parameterType="string" resultMap="userResultMap">
		SELECT
			*
		FROM
			user
		WHERE
			whdwl_ymd IS NOT NULL;
	</select>
	
	<!-- 휴면 회원정보 조회 -->
	<select id="getDormancyUserInfo" parameterType="string" resultMap="userResultMap">
		SELECT
		    u.*,
		    DATEDIFF(NOW(), MAX(ull.lgn_dt)) AS inactive_days
		FROM
		    user u
		INNER JOIN user_login_log ull
		ON u.id = ull.id
		WHERE
		    u.whdwl_ymd IS NULL
		GROUP BY
		    u.id
		HAVING
		    inactive_days > 365;
	</select>

	<!-- 회원 로그인내역 조회 -->
	<select id="getUserLoginLog" parameterType="string" resultMap="userResultMap">
		SELECT
			ull.login_no,
			u.id,
			ar.authrt_nm,
			ull.lgn_dt
		FROM
			user u INNER JOIN user_login_log ull
			ON u.id = ull.id
			INNER JOIN authrt ar
			ON u.authrt_cd = ar.authrt_cd;
	</select>
	
	<!-- 회원 권한정보 조회 -->
	<select id="getAuthrtInfo" parameterType="string" resultMap="userResultMap">
		SELECT
			authrt_cd,
			authrt_nm
		FROM
			authrt;
	</select>
</mapper>
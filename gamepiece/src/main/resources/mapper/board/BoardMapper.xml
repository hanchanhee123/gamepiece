<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gamepiece.admin.board.mapper.BoardMapper">




	<resultMap type="gamepiece.admin.board.domain.Board" id="BoardResultMap">
    <id column="bbs_no"  property="boardNum" />
    <result column="bbs_cate_cd" property="boardCategory" />
    <result column="bbs_title" property="boardTitle" />
    <result column="bbs_cn" property="boardContent" />
    <result column="id" property="boardUserid" />
    <result column="bbs_like" property="boardLikeCnt" />
    <result column="bbs_dislike" property="boardDisLikeCnt" />
    <result column="bbs_view" property="boardViewCnt" />
    <result column="bbs_ymd" property="boardYmd" />



    <association property="userInfo" javaType="gamepiece.admin.user.domain.User">
        <id column="id" property="id" />
        <result column="authrt_cd" property="authrt_cd" />
        <result column="user_pw" property="user_pw" />
        <result column="user_nm" property="user_nm" />
        <result column="user_gender" property="user_gender" />
        <result column="user_eml_addr" property="user_eml_addr" />
        <result column="user_brdt" property="user_brdt" />
        <result column="user_telno" property="user_telno" />
        <result column="user_nn" property="user_nn" />
        <result column="join_ymd" property="join_ymd" />
        <result column="whdwl_ymd" property="whdwl_ymd" />
    </association>
    
    
        <association property="categoryInfo" javaType="gamepiece.admin.boardCategory.domain.BoardCategory">
        <id column="bbs_cate_cd" property="categoryCode" />
        <result column="bbs_cate_nm" property="categoryName" />
        <result column="admin_id" property="adminId" />
        <result column="reg_ymd" property="categoryYmd" />
              <result column="board_count" property="boardCount" />
    </association>
</resultMap>


<select id="getCntBoard" resultType="int">
		SELECT
			COUNT(*)
		FROM
			 boards b
	WHERE
        b.isdelete = 'active'
</select>



<select id="getBoardsList" parameterType="gamepiece.util.Pageable" resultMap="BoardResultMap">
    SELECT
        b.bbs_no,
        b.bbs_cate_cd,
        b.bbs_title,
        b.bbs_view,
        b.bbs_like,
        b.bbs_dislike,
        u.user_nn,
        b.bbs_ymd
    FROM
        boards b INNER JOIN boards_categories bc
        ON b.bbs_cate_cd = bc.bbs_cate_cd
        INNER JOIN user u
        ON b.id = u.id
    WHERE
        b.isdelete = 'active'
    ORDER BY
        CAST(SUBSTRING_INDEX(b.bbs_no,'bbs_',-1) AS UNSIGNED)
    LIMIT #{rowPerPage} OFFSET #{offset};
</select>





<insert id="addBoard" parameterType="Board">
    INSERT INTO boards(
        bbs_no,
        bbs_cate_cd,
        id,
        bbs_title,
        bbs_cn,
        bbs_like,
        bbs_dislike,
        bbs_view,
        bbs_ymd
    )VALUES(
        CONCAT('bbs_', LPAD((
            SELECT next_num FROM (
                SELECT MAX(CAST(SUBSTRING_INDEX(bbs_no, 'bbs_', -1) AS UNSIGNED)) + 1 AS next_num 
                FROM boards
            ) AS temp
        ), 2, '0')),
        #{boardCategory},
        CONCAT('id', LPAD(#{idN}+1,2,'0')),
        #{boardTitle},
        #{boardContent},
        #{boardLikeCnt},
        #{boardDisLikeCnt},
        #{boardViewCnt},
        CURDATE()
    );
</insert>
<select id="countBoards" parameterType="Board">

	SELECT 
	COUNT(*) 
	FROM
	 boards

</select>

	<select id="getBoardInfo" parameterType="string" resultMap="BoardResultMap">	
	
	
	SELECT
		b.bbs_no,
		b.bbs_cate_cd,
		bc.bbs_cate_nm,
		b.bbs_title,
		b.bbs_cn,
		b.bbs_view,
		b.bbs_like,
		b.bbs_dislike,
		b.bbs_ymd
		
	FROM
	    boards b LEFT JOIN boards_categories bc
	    ON b.bbs_cate_cd = bc.bbs_cate_cd
	  
	 WHERE
	bbs_no = #{boardNum};
		
	
	</select>

<update id="modifyBoard" parameterType="Board">
    UPDATE boards
    <set>
        <if test="boardCategory != null and boardCategory != ''">
            bbs_cate_cd = #{boardCategory}
        </if>
        <if test="boardTitle != null and boardTitle != ''">
            ,bbs_title = #{boardTitle}
        </if>
        <if test="boardContent != null and boardContent != ''">
            ,bbs_cn = #{boardContent}
        </if>
    </set>
    WHERE 
    	bbs_no = #{boardNum}
</update>


<update id="removeBoard" parameterType="string">

		UPDATE 
			boards
		SET
			isdelete = 'delete'
		WHERE 
			bbs_no=#{boardNum};

</update>




</mapper>